generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum DataSource {
  DATABENTO
  FRED
  YAHOO
  INTERNAL
}

enum EconCategory {
  RATES
  INFLATION
  LABOR
  ACTIVITY
  VOLATILITY
  COMMODITIES
  FX
  EQUITY
  MONEY
  OTHER
}

enum ReportCategory {
  CPI
  PPI
  PCE
  EMPLOYMENT
  GDP
  PMI
  RETAIL
  HOUSING
  POLICY
  OTHER
}

enum Timeframe {
  M1
  M5
  M15
  H1
  H4
  D1
}

enum SignalDirection {
  BULLISH
  BEARISH
}

enum SignalStatus {
  FORMING
  ACTIVE
  TARGET_HIT
  STOPPED_OUT
}

enum BhgPhase {
  TOUCHED
  HOOKED
  GO_FIRED
  EXPIRED
  STOPPED
  TP1_HIT
  TP2_HIT
}

enum IngestionStatus {
  RUNNING
  COMPLETED
  FAILED
}

model Symbol {
  code            String      @id @db.VarChar(16)
  displayName     String      @db.VarChar(64)
  shortName       String?     @db.VarChar(64)
  description     String?
  tickSize        Decimal     @db.Decimal(18, 6)
  dataSource      DataSource
  dataset         String?     @db.VarChar(64)
  databentoSymbol String?     @db.VarChar(32)
  fredSymbol      String?     @db.VarChar(32)
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @db.Timestamptz(6)
  futuresExMes1h  FuturesExMes1h[]
  futuresExMes1d  FuturesExMes1d[]
  measuredMoves   MeasuredMoveSignal[]
  mappings        SymbolMapping[]

  @@index([dataSource, isActive], map: "symbols_source_active_idx")
  @@map("symbols")
}

model SymbolMapping {
  id              BigInt     @id @default(autoincrement())
  symbolCode      String     @db.VarChar(16)
  source          DataSource
  sourceTable     String     @db.VarChar(64)
  sourceSymbol    String     @db.VarChar(64)
  isPrimary       Boolean    @default(false)
  confidenceScore Decimal?   @default(1) @db.Decimal(5, 4)
  notes           String?
  createdAt       DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @db.Timestamptz(6)
  symbol          Symbol     @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([sourceTable, sourceSymbol], map: "symbol_mappings_source_key")
  @@index([symbolCode, source], map: "symbol_mappings_symbol_source_idx")
  @@map("symbol_mappings")
}

model MesPrice1h {
  id            BigInt     @id @default(autoincrement())
  eventTime     DateTime   @db.Timestamptz(6)
  open          Decimal    @db.Decimal(18, 6)
  high          Decimal    @db.Decimal(18, 6)
  low           Decimal    @db.Decimal(18, 6)
  close         Decimal    @db.Decimal(18, 6)
  volume        BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([eventTime], map: "mes_prices_1h_event_time_key")
  @@map("mes_prices_1h")
}

model MesPrice1m {
  id            BigInt     @id @default(autoincrement())
  eventTime     DateTime   @db.Timestamptz(6)
  open          Decimal    @db.Decimal(18, 6)
  high          Decimal    @db.Decimal(18, 6)
  low           Decimal    @db.Decimal(18, 6)
  close         Decimal    @db.Decimal(18, 6)
  volume        BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([eventTime], map: "mes_prices_1m_event_time_key")
  @@map("mes_prices_1m")
}

model MesPrice15m {
  id            BigInt     @id @default(autoincrement())
  eventTime     DateTime   @db.Timestamptz(6)
  open          Decimal    @db.Decimal(18, 6)
  high          Decimal    @db.Decimal(18, 6)
  low           Decimal    @db.Decimal(18, 6)
  close         Decimal    @db.Decimal(18, 6)
  volume        BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([eventTime], map: "mes_prices_15m_event_time_key")
  @@map("mes_prices_15m")
}

model FuturesExMes1h {
  id            BigInt     @id @default(autoincrement())
  symbolCode    String     @db.VarChar(16)
  eventTime     DateTime   @db.Timestamptz(6)
  open          Decimal    @db.Decimal(18, 6)
  high          Decimal    @db.Decimal(18, 6)
  low           Decimal    @db.Decimal(18, 6)
  close         Decimal    @db.Decimal(18, 6)
  volume        BigInt?
  openInterest  BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?
  symbol        Symbol     @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([symbolCode, eventTime], map: "futures_ex_mes_1h_symbol_time_key")
  @@index([eventTime], map: "futures_ex_mes_1h_time_idx")
  @@map("futures_ex_mes_1h")
}

model FuturesExMes1d {
  id            BigInt     @id @default(autoincrement())
  symbolCode    String     @db.VarChar(16)
  eventDate     DateTime   @db.Date
  open          Decimal    @db.Decimal(18, 6)
  high          Decimal    @db.Decimal(18, 6)
  low           Decimal    @db.Decimal(18, 6)
  close         Decimal    @db.Decimal(18, 6)
  volume        BigInt?
  openInterest  BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?
  symbol        Symbol     @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([symbolCode, eventDate], map: "futures_ex_mes_1d_symbol_date_key")
  @@index([eventDate], map: "futures_ex_mes_1d_date_idx")
  @@map("futures_ex_mes_1d")
}

model EconObservation1d {
  id            BigInt         @id @default(autoincrement())
  category      EconCategory
  seriesId      String         @db.VarChar(50)
  eventDate     DateTime       @db.Date
  value         Decimal?       @db.Decimal(24, 8)
  source        DataSource     @default(FRED)
  ingestedAt    DateTime       @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime       @default(now()) @db.Timestamptz(6)
  rowHash       String?        @db.VarChar(64)
  metadata      Json?
  series        EconomicSeries @relation(fields: [seriesId], references: [seriesId], onDelete: Cascade)

  @@unique([category, seriesId, eventDate], map: "econ_obs_1d_cat_series_date_key")
  @@index([eventDate], map: "econ_obs_1d_date_idx")
  @@index([category], map: "econ_obs_1d_category_idx")
  @@map("econ_observations_1d")
}

model MktIndexes1d {
  id            BigInt     @id @default(autoincrement())
  symbolCode    String     @db.VarChar(32)
  eventDate     DateTime   @db.Date
  open          Decimal?   @db.Decimal(18, 6)
  high          Decimal?   @db.Decimal(18, 6)
  low           Decimal?   @db.Decimal(18, 6)
  close         Decimal?   @db.Decimal(18, 6)
  volume        BigInt?
  source        DataSource @default(YAHOO)
  sourceSymbol  String?    @db.VarChar(50)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([symbolCode, eventDate], map: "mkt_indexes_1d_symbol_date_key")
  @@index([eventDate], map: "mkt_indexes_1d_date_idx")
  @@map("mkt_indexes_1d")
}

model MktSpot1d {
  id            BigInt     @id @default(autoincrement())
  symbolCode    String     @db.VarChar(32)
  eventDate     DateTime   @db.Date
  value         Decimal?   @db.Decimal(18, 6)
  source        DataSource @default(INTERNAL)
  sourceSymbol  String?    @db.VarChar(50)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([symbolCode, eventDate], map: "mkt_spot_1d_symbol_date_key")
  @@index([eventDate], map: "mkt_spot_1d_date_idx")
  @@map("mkt_spot_1d")
}

model EconNews1d {
  id             BigInt    @id @default(autoincrement())
  articleId      String?   @db.VarChar(128)
  eventDate      DateTime  @db.Date
  publishedAt    DateTime? @db.Timestamptz(6)
  headline       String
  summary        String?
  content        String?
  source         String?   @db.VarChar(100)
  author         String?   @db.VarChar(100)
  url            String?
  sentimentLabel String?   @db.VarChar(32)
  topics         String[]  @default([])
  subjects       String[]  @default([])
  tags           String[]  @default([])
  ingestedAt     DateTime  @default(now()) @db.Timestamptz(6)
  knowledgeTime  DateTime  @default(now()) @db.Timestamptz(6)
  rowHash        String?   @unique(map: "econ_news_1d_row_hash_key") @db.VarChar(64)
  rawPayload     Json?

  @@index([eventDate], map: "econ_news_1d_date_idx")
  @@index([source], map: "econ_news_1d_source_idx")
  @@index([tags], map: "econ_news_1d_tags_idx", type: Gin)
  @@map("econ_news_1d")
}

model PolicyNews1d {
  id             BigInt     @id @default(autoincrement())
  eventDate      DateTime   @db.Date
  publishedAt    DateTime?  @db.Timestamptz(6)
  headline       String
  summary        String?
  source         String?    @db.VarChar(100)
  region         String?    @db.VarChar(64)
  country        String?    @db.VarChar(64)
  url            String?
  sentimentScore Decimal?   @db.Decimal(8, 4)
  impactScore    Decimal?   @db.Decimal(8, 4)
  tags           String[]   @default([])
  ingestedAt     DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime  DateTime   @default(now()) @db.Timestamptz(6)
  rowHash        String?    @db.VarChar(64)
  rawPayload     Json?

  @@unique([rowHash], map: "policy_news_1d_row_hash_key")
  @@index([eventDate], map: "policy_news_1d_date_idx")
  @@index([source], map: "policy_news_1d_source_idx")
  @@index([tags], map: "policy_news_1d_tags_idx", type: Gin)
  @@map("policy_news_1d")
}

model MacroReport1d {
  id             BigInt         @id @default(autoincrement())
  reportCode     String         @db.VarChar(50)
  reportName     String         @db.VarChar(200)
  category       ReportCategory @default(OTHER)
  eventDate      DateTime       @db.Date
  releaseTime    DateTime?      @db.Timestamptz(6)
  periodLabel    String?        @db.VarChar(32)
  actual         Decimal?       @db.Decimal(24, 8)
  forecast       Decimal?       @db.Decimal(24, 8)
  previous       Decimal?       @db.Decimal(24, 8)
  revised        Decimal?       @db.Decimal(24, 8)
  surprise       Decimal?       @db.Decimal(24, 8)
  surprisePct    Decimal?       @db.Decimal(10, 4)
  unit           String?        @db.VarChar(24)
  source         String?        @db.VarChar(100)
  country        String?        @db.VarChar(64)
  ingestedAt     DateTime       @default(now()) @db.Timestamptz(6)
  knowledgeTime  DateTime       @default(now()) @db.Timestamptz(6)
  rowHash        String?        @db.VarChar(64)
  rawPayload     Json?

  @@unique([reportCode, eventDate], map: "macro_reports_1d_code_date_key")
  @@index([eventDate], map: "macro_reports_1d_date_idx")
  @@index([category, eventDate], map: "macro_reports_1d_category_date_idx")
  @@map("macro_reports_1d")
}

model EconomicSeries {
  seriesId     String              @id @db.VarChar(50)
  displayName  String?             @db.VarChar(200)
  category     EconCategory        @default(OTHER)
  source       DataSource
  sourceSymbol String?             @db.VarChar(50)
  frequency    String?             @db.VarChar(20)
  units        String?             @db.VarChar(32)
  isActive     Boolean             @default(true)
  metadata     Json?
  createdAt    DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime            @updatedAt @db.Timestamptz(6)
  observations EconObservation1d[]

  @@index([category, isActive], map: "economic_series_category_active_idx")
  @@map("economic_series")
}

model DataSourceRegistry {
  sourceId        String   @id @db.VarChar(64)
  sourceName      String   @db.VarChar(128)
  description     String?
  targetTable     String   @db.VarChar(64)
  apiProvider     String   @db.VarChar(64)
  updateFrequency String   @db.VarChar(32)
  authEnvVar      String?  @db.VarChar(64)
  ingestionScript String?  @db.VarChar(128)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  @@index([isActive], map: "data_sources_active_idx")
  @@map("data_source_registry")
}

model MeasuredMoveSignal {
  id               BigInt          @id @default(autoincrement())
  symbolCode       String          @db.VarChar(16)
  timeframe        Timeframe
  timestamp        DateTime        @db.Timestamptz(6)
  direction        SignalDirection
  status           SignalStatus
  pointA           Decimal         @db.Decimal(18, 6)
  pointB           Decimal         @db.Decimal(18, 6)
  pointC           Decimal         @db.Decimal(18, 6)
  entry            Decimal         @db.Decimal(18, 6)
  stop             Decimal         @db.Decimal(18, 6)
  target100        Decimal         @db.Decimal(18, 6)
  target1236       Decimal         @db.Decimal(18, 6)
  retracementRatio Decimal         @db.Decimal(8, 6)
  quality          Int
  source           String          @default("halsey") @db.VarChar(32)
  createdAt        DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime        @updatedAt @db.Timestamptz(6)
  symbol           Symbol          @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([symbolCode, timeframe, timestamp, direction], map: "mm_signals_dedupe_key")
  @@index([symbolCode, timeframe, timestamp], map: "mm_signals_symbol_tf_ts_idx")
  @@map("measured_move_signals")
}

model IngestionRun {
  id            BigInt           @id @default(autoincrement())
  job           String           @db.VarChar(64)
  startedAt     DateTime         @default(now()) @db.Timestamptz(6)
  finishedAt    DateTime?        @db.Timestamptz(6)
  status        IngestionStatus  @default(RUNNING)
  rowsProcessed Int              @default(0)
  rowsInserted  Int              @default(0)
  rowsFailed    Int              @default(0)
  details       Json?

  @@index([job, startedAt], map: "ingestion_runs_job_started_idx")
  @@map("ingestion_runs")
}

// ─── BHG (Break-Hook-Go) Setups ───────────────────────────────────────────

model BhgSetup {
  id               BigInt          @id @default(autoincrement())
  setupId          String          @unique @db.VarChar(128)
  direction        SignalDirection
  timeframe        Timeframe
  phase            BhgPhase
  fibLevel         Decimal         @db.Decimal(18, 6)
  fibRatio         Decimal         @db.Decimal(8, 6)

  touchTime        DateTime?       @db.Timestamptz(6)
  hookTime         DateTime?       @db.Timestamptz(6)
  hookLow          Decimal?        @db.Decimal(18, 6)
  hookHigh         Decimal?        @db.Decimal(18, 6)
  hookClose        Decimal?        @db.Decimal(18, 6)
  goTime           DateTime?       @db.Timestamptz(6)
  goType           String?         @db.VarChar(10)

  entry            Decimal?        @db.Decimal(18, 6)
  stopLoss         Decimal?        @db.Decimal(18, 6)
  tp1              Decimal?        @db.Decimal(18, 6)
  tp2              Decimal?        @db.Decimal(18, 6)

  // Outcome tracking (filled after horizon)
  tp1Hit           Boolean?
  tp2Hit           Boolean?
  slHit            Boolean?
  tp1HitTime       DateTime?       @db.Timestamptz(6)
  tp2HitTime       DateTime?       @db.Timestamptz(6)
  slHitTime        DateTime?       @db.Timestamptz(6)
  maxFavorable     Decimal?        @db.Decimal(18, 6)
  maxAdverse       Decimal?        @db.Decimal(18, 6)

  // Model scoring
  pTp1             Decimal?        @db.Decimal(8, 6)
  pTp2             Decimal?        @db.Decimal(8, 6)
  modelVersion     String?         @db.VarChar(64)

  // Alignment at GO time
  correlationScore Decimal?        @db.Decimal(8, 6)
  vixLevel         Decimal?        @db.Decimal(10, 4)

  createdAt        DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime        @updatedAt @db.Timestamptz(6)

  @@index([direction, phase], map: "bhg_setups_direction_phase_idx")
  @@index([goTime], map: "bhg_setups_go_time_idx")
  @@index([timeframe, goTime], map: "bhg_setups_tf_go_time_idx")
  @@map("bhg_setups")
}

// ─── MES Model Registry ───────────────────────────────────────────────────

model MesModelRegistry {
  id             BigInt   @id @default(autoincrement())
  modelName      String   @db.VarChar(128)
  version        String   @db.VarChar(64)
  trainedAt      DateTime @db.Timestamptz(6)
  oofBrier       Decimal? @db.Decimal(10, 8)
  oofLogLoss     Decimal? @db.Decimal(10, 8)
  oofAuc         Decimal? @db.Decimal(10, 8)
  trainRows      Int
  features       Json
  hyperparams    Json?
  artifactPath   String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  @@unique([modelName, version], map: "mes_model_registry_name_version_key")
  @@map("mes_model_registry")
}
