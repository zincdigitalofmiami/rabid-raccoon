generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum DataSource {
  DATABENTO
  FRED
  YAHOO
  INTERNAL
}

enum EconCategory {
  RATES
  INFLATION
  LABOR
  ACTIVITY
  VOLATILITY
  COMMODITIES
  FX
  EQUITY
  MONEY
  OTHER
}

enum ReportCategory {
  CPI
  PPI
  PCE
  EMPLOYMENT
  GDP
  PMI
  RETAIL
  HOUSING
  POLICY
  OTHER
}

enum Timeframe {
  M1
  M5
  M15
  H1
  H4
  D1
}

enum SignalDirection {
  BULLISH
  BEARISH
}

enum SignalStatus {
  FORMING
  ACTIVE
  TARGET_HIT
  STOPPED_OUT
}

model Symbol {
  code            String      @id @db.VarChar(16)
  displayName     String      @db.VarChar(64)
  shortName       String?     @db.VarChar(64)
  description     String?
  tickSize        Float
  dataSource      DataSource
  dataset         String?     @db.VarChar(64)
  databentoSymbol String?     @db.VarChar(32)
  fredSymbol      String?     @db.VarChar(32)
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @db.Timestamptz(6)
  futuresExMes1h  FuturesExMes1h[]
  measuredMoves   MeasuredMoveSignal[]
  mappings        SymbolMapping[]

  @@index([dataSource, isActive], map: "symbols_source_active_idx")
  @@map("symbols")
}

model SymbolMapping {
  id              BigInt     @id @default(autoincrement())
  symbolCode      String     @db.VarChar(16)
  source          DataSource
  sourceTable     String     @db.VarChar(64)
  sourceSymbol    String     @db.VarChar(64)
  isPrimary       Boolean    @default(false)
  confidenceScore Float?     @default(1)
  notes           String?
  createdAt       DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @db.Timestamptz(6)
  symbol          Symbol     @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([sourceTable, sourceSymbol], map: "symbol_mappings_source_key")
  @@index([symbolCode, source], map: "symbol_mappings_symbol_source_idx")
  @@map("symbol_mappings")
}

model MesPrice1h {
  id            BigInt     @id @default(autoincrement())
  eventTime     DateTime   @db.Timestamptz(6)
  open          Float
  high          Float
  low           Float
  close         Float
  volume        BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([eventTime], map: "mes_prices_1h_event_time_key")
  @@index([eventTime], map: "mes_prices_1h_event_time_idx")
  @@map("mes_prices_1h")
}

model MesPrice1m {
  id            BigInt     @id @default(autoincrement())
  eventTime     DateTime   @db.Timestamptz(6)
  open          Float
  high          Float
  low           Float
  close         Float
  volume        BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([eventTime], map: "mes_prices_1m_event_time_key")
  @@index([eventTime], map: "mes_prices_1m_event_time_idx")
  @@map("mes_prices_1m")
}

model FuturesExMes1h {
  id            BigInt     @id @default(autoincrement())
  symbolCode    String     @db.VarChar(16)
  eventTime     DateTime   @db.Timestamptz(6)
  open          Float
  high          Float
  low           Float
  close         Float
  volume        BigInt?
  openInterest  BigInt?
  source        DataSource @default(DATABENTO)
  sourceDataset String?    @db.VarChar(64)
  sourceSchema  String?    @db.VarChar(32)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?
  symbol        Symbol     @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([symbolCode, eventTime], map: "futures_ex_mes_1h_symbol_time_key")
  @@index([symbolCode, eventTime], map: "futures_ex_mes_1h_symbol_time_idx")
  @@index([eventTime], map: "futures_ex_mes_1h_time_idx")
  @@map("futures_ex_mes_1h")
}

model EconRates1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_rates_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_rates_1d_series_date_idx")
  @@index([eventDate], map: "econ_rates_1d_date_idx")
  @@map("econ_rates_1d")
}

model EconYields1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_yields_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_yields_1d_series_date_idx")
  @@index([eventDate], map: "econ_yields_1d_date_idx")
  @@map("econ_yields_1d")
}

model EconFx1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_fx_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_fx_1d_series_date_idx")
  @@index([eventDate], map: "econ_fx_1d_date_idx")
  @@map("econ_fx_1d")
}

model EconVolIndices1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_vol_indices_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_vol_indices_1d_series_date_idx")
  @@index([eventDate], map: "econ_vol_indices_1d_date_idx")
  @@map("econ_vol_indices_1d")
}

model EconInflation1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_inflation_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_inflation_1d_series_date_idx")
  @@index([eventDate], map: "econ_inflation_1d_date_idx")
  @@map("econ_inflation_1d")
}

model EconLabor1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_labor_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_labor_1d_series_date_idx")
  @@index([eventDate], map: "econ_labor_1d_date_idx")
  @@map("econ_labor_1d")
}

model EconActivity1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_activity_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_activity_1d_series_date_idx")
  @@index([eventDate], map: "econ_activity_1d_date_idx")
  @@map("econ_activity_1d")
}

model EconMoney1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_money_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_money_1d_series_date_idx")
  @@index([eventDate], map: "econ_money_1d_date_idx")
  @@map("econ_money_1d")
}

model EconCommodities1d {
  id            BigInt     @id @default(autoincrement())
  seriesId      String     @db.VarChar(50)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(FRED)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([seriesId, eventDate], map: "econ_commodities_1d_series_date_key")
  @@index([seriesId, eventDate], map: "econ_commodities_1d_series_date_idx")
  @@index([eventDate], map: "econ_commodities_1d_date_idx")
  @@map("econ_commodities_1d")
}

model MktIndexes1d {
  id            BigInt     @id @default(autoincrement())
  symbol        String     @db.VarChar(32)
  eventDate     DateTime   @db.Date
  open          Float?
  high          Float?
  low           Float?
  close         Float?
  volume        BigInt?
  source        DataSource @default(YAHOO)
  sourceSymbol  String?    @db.VarChar(50)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([symbol, eventDate], map: "mkt_indexes_1d_symbol_date_key")
  @@index([symbol, eventDate], map: "mkt_indexes_1d_symbol_date_idx")
  @@index([eventDate], map: "mkt_indexes_1d_date_idx")
  @@map("mkt_indexes_1d")
}

model MktSpot1d {
  id            BigInt     @id @default(autoincrement())
  symbol        String     @db.VarChar(32)
  eventDate     DateTime   @db.Date
  value         Float?
  source        DataSource @default(INTERNAL)
  sourceSymbol  String?    @db.VarChar(50)
  ingestedAt    DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime DateTime   @default(now()) @db.Timestamptz(6)
  rowHash       String?    @db.VarChar(64)
  metadata      Json?

  @@unique([symbol, eventDate], map: "mkt_spot_1d_symbol_date_key")
  @@index([symbol, eventDate], map: "mkt_spot_1d_symbol_date_idx")
  @@index([eventDate], map: "mkt_spot_1d_date_idx")
  @@map("mkt_spot_1d")
}

model EconNews1d {
  id             BigInt    @id @default(autoincrement())
  articleId      String?   @db.VarChar(128)
  eventDate      DateTime  @db.Date
  publishedAt    DateTime? @db.Timestamptz(6)
  headline       String
  summary        String?
  content        String?
  source         String?   @db.VarChar(100)
  author         String?   @db.VarChar(100)
  url            String?
  sentimentLabel String?   @db.VarChar(32)
  topics         String[]  @default([])
  subjects       String[]  @default([])
  tags           String[]  @default([])
  ingestedAt     DateTime  @default(now()) @db.Timestamptz(6)
  knowledgeTime  DateTime  @default(now()) @db.Timestamptz(6)
  rowHash        String?   @unique(map: "econ_news_1d_row_hash_key") @db.VarChar(64)
  rawPayload     Json?

  @@index([eventDate], map: "econ_news_1d_date_idx")
  @@index([source], map: "econ_news_1d_source_idx")
  @@index([tags], map: "econ_news_1d_tags_idx", type: Gin)
  @@map("econ_news_1d")
}

model PolicyNews1d {
  id             BigInt     @id @default(autoincrement())
  eventDate      DateTime   @db.Date
  publishedAt    DateTime?  @db.Timestamptz(6)
  headline       String
  summary        String?
  source         String?    @db.VarChar(100)
  region         String?    @db.VarChar(64)
  country        String?    @db.VarChar(64)
  url            String?
  sentimentScore Float?
  impactScore    Float?
  tags           String[]    @default([])
  ingestedAt     DateTime   @default(now()) @db.Timestamptz(6)
  knowledgeTime  DateTime   @default(now()) @db.Timestamptz(6)
  rowHash        String?    @db.VarChar(64)
  rawPayload     Json?

  @@unique([rowHash], map: "policy_news_1d_row_hash_key")
  @@index([eventDate], map: "policy_news_1d_date_idx")
  @@index([source], map: "policy_news_1d_source_idx")
  @@index([tags], map: "policy_news_1d_tags_idx", type: Gin)
  @@map("policy_news_1d")
}

model MacroReport1d {
  id             BigInt         @id @default(autoincrement())
  reportCode     String         @db.VarChar(50)
  reportName     String         @db.VarChar(200)
  category       ReportCategory @default(OTHER)
  eventDate      DateTime       @db.Date
  releaseTime    DateTime?      @db.Timestamptz(6)
  periodLabel    String?        @db.VarChar(32)
  actual         Float?
  forecast       Float?
  previous       Float?
  revised        Float?
  surprise       Float?
  surprisePct    Float?
  unit           String?        @db.VarChar(24)
  source         String?        @db.VarChar(100)
  country        String?        @db.VarChar(64)
  ingestedAt     DateTime       @default(now()) @db.Timestamptz(6)
  knowledgeTime  DateTime       @default(now()) @db.Timestamptz(6)
  rowHash        String?        @db.VarChar(64)
  rawPayload     Json?

  @@unique([reportCode, eventDate], map: "macro_reports_1d_code_date_key")
  @@index([eventDate], map: "macro_reports_1d_date_idx")
  @@index([category, eventDate], map: "macro_reports_1d_category_date_idx")
  @@map("macro_reports_1d")
}

model EconomicSeries {
  seriesId     String       @id @db.VarChar(50)
  displayName  String?      @db.VarChar(200)
  category     EconCategory @default(OTHER)
  source       DataSource
  sourceSymbol String?      @db.VarChar(50)
  frequency    String?      @db.VarChar(20)
  units        String?      @db.VarChar(32)
  isActive     Boolean      @default(true)
  metadata     Json?
  createdAt    DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime     @updatedAt @db.Timestamptz(6)

  @@index([category, isActive], map: "economic_series_category_active_idx")
  @@map("economic_series")
}

model DataSourceRegistry {
  sourceId        String   @id @db.VarChar(64)
  sourceName      String   @db.VarChar(128)
  description     String?
  targetTable     String   @db.VarChar(64)
  apiProvider     String   @db.VarChar(64)
  updateFrequency String   @db.VarChar(32)
  authEnvVar      String?  @db.VarChar(64)
  ingestionScript String?  @db.VarChar(128)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  @@index([isActive], map: "data_sources_active_idx")
  @@map("data_source_registry")
}

model MeasuredMoveSignal {
  id               BigInt          @id @default(autoincrement())
  symbolCode       String          @db.VarChar(16)
  timeframe        Timeframe
  timestamp        DateTime        @db.Timestamptz(6)
  direction        SignalDirection
  status           SignalStatus
  pointA           Float
  pointB           Float
  pointC           Float
  entry            Float
  stop             Float
  target100        Float
  target1236       Float
  retracementRatio Float
  quality          Int
  source           String          @default("halsey") @db.VarChar(32)
  createdAt        DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime        @updatedAt @db.Timestamptz(6)
  symbol           Symbol          @relation(fields: [symbolCode], references: [code], onDelete: Cascade)

  @@unique([symbolCode, timeframe, timestamp, direction, entry, target100], map: "mm_signals_dedupe_key")
  @@index([symbolCode, timeframe, timestamp], map: "mm_signals_symbol_tf_ts_idx")
  @@map("measured_move_signals")
}

model IngestionRun {
  id            BigInt    @id @default(autoincrement())
  job           String    @db.VarChar(64)
  startedAt     DateTime  @default(now()) @db.Timestamptz(6)
  finishedAt    DateTime? @db.Timestamptz(6)
  status        String    @default("RUNNING") @db.VarChar(24)
  rowsProcessed Int       @default(0)
  rowsInserted  Int       @default(0)
  rowsFailed    Int       @default(0)
  details       Json?

  @@index([job, startedAt], map: "ingestion_runs_job_started_idx")
  @@map("ingestion_runs")
}
