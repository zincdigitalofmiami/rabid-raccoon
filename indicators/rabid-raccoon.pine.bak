// This Pine Script‚Ñ¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© Kirk / ZINC Digital
// @version=6

indicator("Rabid Raccoon", shorttitle="ü¶ù RR", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

import TradingView/ZigZag/7 as zigzag

//#region === INPUTS & CONFIGURATION ===

// --- Feature Toggles ---
showMeasuredMoves   = input.bool(true,  "Show Measured Moves",      group="Feature Toggles")
showAutoFib         = input.bool(true,  "Show Auto-Fibonacci",      group="Feature Toggles")
showBreakHookGo     = input.bool(true,  "Show Break-Hook-Go",       group="Feature Toggles")
showCorrelation     = input.bool(false, "Show Correlation Analysis", group="Feature Toggles")
showRiskManagement  = input.bool(true,  "Show Risk Management",     group="Feature Toggles")
debugMode           = input.bool(false, "Debug Mode",               group="Feature Toggles")

// --- Measured Move Settings ---
mmLookback          = input.int(20,     "Swing Lookback Period",    minval=5, maxval=100, group="Measured Moves")
mmTolerance         = input.float(0.1,  "Move Equality Tolerance",  minval=0.01, maxval=0.5, step=0.01, group="Measured Moves")

// --- Fibonacci Settings (ZigZag Auto Fib) ---
fibDeviation        = input.float(3,    "Fib Deviation",            minval=0, tooltip="ATR multiplier for ZigZag pivot sensitivity", group="Fibonacci")
fibDepth            = input.int(10,     "Fib Depth",                minval=2, tooltip="Minimum bars between pivots", group="Fibonacci")
fibReverse          = input.bool(false, "Reverse",                  group="Fibonacci")
fibExtendRight      = input.bool(true,  "Extend Right",             group="Fibonacci")
fibShowPrices       = input.bool(true,  "Show Prices",              group="Fibonacci")
fibShowLevels       = input.bool(true,  "Show Levels",              group="Fibonacci")
fibShowExtensions   = input.bool(true,  "Show Extensions",          group="Fibonacci")
fibBgTransparency   = input.int(85,     "Background Transparency",  minval=0, maxval=100, group="Fibonacci")
fibEntryLabels      = input.bool(true,  "Show Entry Labels",        group="Fibonacci")

// --- Break-Hook-Go Settings ---
bhgSensitivity      = input.int(3,      "BHG Sensitivity",          minval=1, maxval=10, group="Break-Hook-Go")
bhgPullbackFib      = input.float(0.5,  "Pullback Fib Threshold",   minval=0.3, maxval=0.786, step=0.01, group="Break-Hook-Go")
bhgShowLabels       = input.bool(true,  "Show BHG Labels",          group="Break-Hook-Go")

// --- Correlation Settings ---
corrSymbol1         = input.symbol("VIX",    "Correlation Symbol 1", group="Correlation")
corrSymbol2         = input.symbol("DXY",    "Correlation Symbol 2", group="Correlation")
corrSymbol3         = input.symbol("NQ1!",   "Correlation Symbol 3", group="Correlation")
corrPeriod          = input.int(20,          "Correlation Period",   minval=5, maxval=100, group="Correlation")

// --- Risk Management Settings ---
riskAccountSize     = input.float(10000, "Account Size ($)",         minval=100, group="Risk Management")
riskPerTrade        = input.float(1.0,   "Risk Per Trade (%)",       minval=0.1, maxval=10.0, step=0.1, group="Risk Management")
riskTickValue       = input.float(1.25,  "Tick Value ($)",           group="Risk Management")  // MES = $1.25/tick

// --- Swing Detection Settings ---
swingLeftBars       = input.int(5,      "Swing Left Bars",          minval=1, maxval=20, group="Swing Detection")
swingRightBars      = input.int(5,      "Swing Right Bars",         minval=1, maxval=20, group="Swing Detection")
swingMaxHistory     = input.int(50,     "Max Swing History",        minval=10, maxval=200, group="Swing Detection")
debugSwingMarkers   = input.bool(false, "Debug: Show Swing Markers", group="Swing Detection")

//#endregion


//#region === USER-DEFINED TYPES ===

type SwingPoint
    float   price
    int     barIdx
    bool    isHigh

type MeasuredMove
    SwingPoint  legA_start
    SwingPoint  legA_end
    SwingPoint  legB_start
    float       projectedTarget
    bool        isBullish
    bool        isActive

type FibLevel
    float   ratio
    float   price
    string  label
    color   clr

type FibSet
    SwingPoint  swingHigh
    SwingPoint  swingLow
    array<FibLevel> levels
    array<FibLevel> extensions

type RiskProfile
    float   entryPrice
    float   stopLoss
    float   target
    float   positionSize
    float   riskReward
    float   dollarRisk

type CorrelationData
    string  symbol
    float   coefficient
    float   currentPrice
    float   percentChange

//#endregion


//#region === CORE UTILITIES (Swing Detection) ===

// Shared swing high/low detection used by multiple modules

// --- Persistent Storage ---
var array<SwingPoint> swingHighs = array.new<SwingPoint>()
var array<SwingPoint> swingLows  = array.new<SwingPoint>()

// --- Pivot Detection ---
pivotHi = ta.pivothigh(high, swingLeftBars, swingRightBars)
pivotLo = ta.pivotlow(low,  swingLeftBars, swingRightBars)

// --- Store Confirmed Swing Highs ---
if not na(pivotHi)
    newHigh = SwingPoint.new(pivotHi, bar_index - swingRightBars, true)
    array.unshift(swingHighs, newHigh)
    if array.size(swingHighs) > swingMaxHistory
        array.pop(swingHighs)

// --- Store Confirmed Swing Lows ---
if not na(pivotLo)
    newLow = SwingPoint.new(pivotLo, bar_index - swingRightBars, false)
    array.unshift(swingLows, newLow)
    if array.size(swingLows) > swingMaxHistory
        array.pop(swingLows)

// --- Convenience: Latest Swing High / Low ---
latestSwingHighPrice = array.size(swingHighs) > 0 ? array.get(swingHighs, 0).price  : na
latestSwingHighBar   = array.size(swingHighs) > 0 ? array.get(swingHighs, 0).barIdx : int(na)
latestSwingLowPrice  = array.size(swingLows)  > 0 ? array.get(swingLows, 0).price   : na
latestSwingLowBar    = array.size(swingLows)  > 0 ? array.get(swingLows, 0).barIdx  : int(na)

// --- Helper: Find Nearest Swing to a Given Bar ---
findNearestSwing(int targetBar) =>
    SwingPoint result = na
    int bestDist = 999999
    if array.size(swingHighs) > 0
        for i = 0 to array.size(swingHighs) - 1
            SwingPoint sp = array.get(swingHighs, i)
            int dist = math.abs(sp.barIdx - targetBar)
            if dist < bestDist
                bestDist := dist
                result   := sp
    if array.size(swingLows) > 0
        for i = 0 to array.size(swingLows) - 1
            SwingPoint sp = array.get(swingLows, i)
            int dist = math.abs(sp.barIdx - targetBar)
            if dist < bestDist
                bestDist := dist
                result   := sp
    result

// --- Debug: Swing Markers ---
if debugSwingMarkers
    if not na(pivotHi)
        label.new(bar_index - swingRightBars, pivotHi, "‚ñº", style=label.style_none, textcolor=color.red, size=size.tiny)
    if not na(pivotLo)
        label.new(bar_index - swingRightBars, pivotLo, "‚ñ≤", style=label.style_none, textcolor=color.green, size=size.tiny)

//#endregion


//#region === MEASURED MOVE DETECTION ===

if showMeasuredMoves
    // TODO: Implement measured move detection
    // - Identify equal-length price swings using swing pivots
    // - Draw projected targets
    // - Return MeasuredMove UDTs
    if debugMode
        log.info("Measured Moves module active")

//#endregion


//#region === AUTO-FIBONACCI ENGINE ===

// --- Persistent Fib Drawing Objects ---
var line[]  fibLines  = array.new<line>()
var label[] fibLabels = array.new<label>()
var box[]   fibBoxes  = array.new<box>()

// --- Fib State ---
var float fibAnchorHigh     = na
var float fibAnchorLow      = na
var int   fibAnchorHighBar  = int(na)
var int   fibAnchorLowBar   = int(na)
var bool  fibIsBullish      = true
var int   fibSignalCount    = 0

if showAutoFib
    // Determine fib anchor from most recent swing pair
    bool haveSwings = array.size(swingHighs) >= 1 and array.size(swingLows) >= 1

    if haveSwings
        SwingPoint sh = array.get(swingHighs, 0)
        SwingPoint sl = array.get(swingLows, 0)

        // Determine trend: if swing low is more recent ‚Üí bullish retracement
        //                   if swing high is more recent ‚Üí bearish retracement
        bool newBull = sl.barIdx > sh.barIdx
        float newHigh = sh.price
        float newLow  = sl.price
        int   newHBar = sh.barIdx
        int   newLBar = sl.barIdx

        // Only redraw when anchors change
        bool anchorsChanged = newHigh != fibAnchorHigh or newLow != fibAnchorLow

        if anchorsChanged
            fibAnchorHigh    := newHigh
            fibAnchorLow     := newLow
            fibAnchorHighBar := newHBar
            fibAnchorLowBar  := newLBar
            fibIsBullish     := newBull

            // Clear previous drawings
            for ln in fibLines
                line.delete(ln)
            array.clear(fibLines)
            for lb in fibLabels
                label.delete(lb)
            array.clear(fibLabels)
            for bx in fibBoxes
                box.delete(bx)
            array.clear(fibBoxes)

            float fibRange = fibAnchorHigh - fibAnchorLow
            int   fibStartBar = math.min(fibAnchorHighBar, fibAnchorLowBar)
            int   fibEndBar   = bar_index + 20

            // Fib ratios and their labels
            float[] ratios = array.from(0.0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0)
            string[] names = array.from("0", ".236", ".382", ".5", ".618", ".786", "1")

            // Calculate levels (bullish: retrace up from low; bearish: retrace down from high)
            if fibShowLevels
                for i = 0 to array.size(ratios) - 1
                    float r   = array.get(ratios, i)
                    string n  = array.get(names, i)
                    float lvl = fibIsBullish ? fibAnchorLow + fibRange * r : fibAnchorHigh - fibRange * r
                    color lc  = fibIsBullish ? fibColorUp : fibColorDn

                    // Highlight .236 and .618 as target zones
                    bool isTarget = r == 0.236 or r == 0.618
                    int  lw = isTarget ? 2 : 1

                    line newLine = line.new(fibStartBar, lvl, fibEndBar, lvl, color=lc, width=lw, style=isTarget ? line.style_solid : line.style_dotted)
                    array.push(fibLines, newLine)

                    // Level label
                    string labelTxt = n + " (" + str.tostring(lvl, format.mintick) + ")"
                    label newLabel = label.new(fibEndBar, lvl, labelTxt, style=label.style_none, textcolor=lc, size=size.tiny)
                    array.push(fibLabels, newLabel)

                    // .236 and .618 target boxes (shaded zone ¬±0.25% of range)
                    if isTarget
                        float zoneHalf = fibRange * 0.005
                        box newBox = box.new(fibStartBar, lvl + zoneHalf, fibEndBar, lvl - zoneHalf, border_color=color.new(lc, 60), bgcolor=color.new(lc, 85))
                        array.push(fibBoxes, newBox)

            // Extension levels
            if fibShowExtensions
                float[] extRatios = array.from(1.272, 1.618)
                string[] extNames = array.from("1.272", "1.618")
                for i = 0 to array.size(extRatios) - 1
                    float r   = array.get(extRatios, i)
                    string n  = array.get(extNames, i)
                    float lvl = fibIsBullish ? fibAnchorLow + fibRange * r : fibAnchorHigh - fibRange * r
                    color lc  = color.new(color.orange, 30)
                    line newLine = line.new(fibStartBar, lvl, fibEndBar, lvl, color=lc, width=1, style=line.style_dashed)
                    array.push(fibLines, newLine)
                    label newLabel = label.new(fibEndBar, lvl, n + " (" + str.tostring(lvl, format.mintick) + ")", style=label.style_none, textcolor=lc, size=size.tiny)
                    array.push(fibLabels, newLabel)

    // --- Entry Labels at .236 and .618 ---
    if fibEntryLabels and not na(fibAnchorHigh) and not na(fibAnchorLow)
        float fibRange2 = fibAnchorHigh - fibAnchorLow
        float fib236 = fibIsBullish ? fibAnchorLow + fibRange2 * 0.236 : fibAnchorHigh - fibRange2 * 0.236
        float fib618 = fibIsBullish ? fibAnchorLow + fibRange2 * 0.618 : fibAnchorHigh - fibRange2 * 0.618
        float zoneTol = fibRange2 * 0.008

        // Price touches .618 zone ‚Üí entry signal (primary)
        bool at618 = math.abs(close - fib618) <= zoneTol
        if at618
            fibSignalCount += 1
            string dir = fibIsBullish ? "LONG" : "SHORT"
            label.new(bar_index, fibIsBullish ? low - zoneTol : high + zoneTol, "‚¨• .618 " + dir, style=fibIsBullish ? label.style_label_up : label.style_label_down, color=fibIsBullish ? fibColorUp : fibColorDn, textcolor=color.white, size=size.small)

        // Price touches .236 zone ‚Üí target / partial TP signal
        bool at236 = math.abs(close - fib236) <= zoneTol
        if at236
            fibSignalCount += 1
            label.new(bar_index, fibIsBullish ? high + zoneTol : low - zoneTol, "üéØ .236 TP", style=fibIsBullish ? label.style_label_down : label.style_label_up, color=color.new(color.orange, 20), textcolor=color.white, size=size.small)

    if debugMode
        log.info("Auto-Fibonacci module active ‚Äî signals: " + str.tostring(fibSignalCount))

//#endregion


//#region === BREAK-HOOK-GO METHODOLOGY ===

// --- BHG State ---
var int   bhgBreakBar      = int(na)
var float bhgBreakLevel    = na
var bool  bhgBreakBull     = true
var bool  bhgHookDone      = false
var int   bhgSignalCount   = 0
var int   bhgPullbackCount = 0

if showBreakHookGo
    bool haveStructure = not na(latestSwingHighPrice) and not na(latestSwingLowPrice)

    if haveStructure
        // =====================
        // BREAK Detection
        // =====================
        // Bullish break: close crosses above the latest swing high
        bool bullBreak = ta.crossover(close, latestSwingHighPrice)
        // Bearish break: close crosses below the latest swing low
        bool bearBreak = ta.crossunder(close, latestSwingLowPrice)

        if bullBreak
            bhgBreakBar   := bar_index
            bhgBreakLevel := latestSwingHighPrice
            bhgBreakBull  := true
            bhgHookDone   := false
            bhgSignalCount += 1
            if bhgShowLabels
                label.new(bar_index, low, "üî® BREAK", style=label.style_label_up, color=color.new(color.teal, 10), textcolor=color.white, size=size.small)

        if bearBreak
            bhgBreakBar   := bar_index
            bhgBreakLevel := latestSwingLowPrice
            bhgBreakBull  := false
            bhgHookDone   := false
            bhgSignalCount += 1
            if bhgShowLabels
                label.new(bar_index, high, "üî® BREAK", style=label.style_label_down, color=color.new(color.red, 10), textcolor=color.white, size=size.small)

        // =====================
        // HOOK (Pullback) Detection
        // =====================
        // After a break, look for price to retrace back toward the broken level
        bool inBreakWindow = not na(bhgBreakBar) and (bar_index - bhgBreakBar) <= bhgSensitivity * 5 and not bhgHookDone

        if inBreakWindow
            // Pullback signal: price retraces to within threshold of the broken level
            bool pullbackToLevel = false
            if bhgBreakBull
                pullbackToLevel := low <= bhgBreakLevel * (1.0 + bhgPullbackFib * 0.01) and close > bhgBreakLevel * 0.998
            else
                pullbackToLevel := high >= bhgBreakLevel * (1.0 - bhgPullbackFib * 0.01) and close < bhgBreakLevel * 1.002

            if pullbackToLevel
                bhgHookDone := true
                bhgPullbackCount += 1
                if bhgShowLabels
                    if bhgBreakBull
                        label.new(bar_index, low, "ü™ù HOOK", style=label.style_label_up, color=color.new(color.blue, 10), textcolor=color.white, size=size.small)
                    else
                        label.new(bar_index, high, "ü™ù HOOK", style=label.style_label_down, color=color.new(color.blue, 10), textcolor=color.white, size=size.small)

        // =====================
        // GO (Continuation Confirmation)
        // =====================
        // After hook, confirm continuation in the break direction
        bool goWindow = bhgHookDone and not na(bhgBreakBar) and (bar_index - bhgBreakBar) <= bhgSensitivity * 10

        if goWindow
            bool goSignal = false
            if bhgBreakBull
                // Bullish go: close makes new high above the break level with momentum
                goSignal := close > bhgBreakLevel and close > open and close > high[1]
            else
                // Bearish go: close makes new low below the break level with momentum
                goSignal := close < bhgBreakLevel and close < open and close < low[1]

            if goSignal
                bhgSignalCount += 1
                bhgHookDone := false  // Reset so we don't fire multiple GOs
                bhgBreakBar := int(na)
                if bhgShowLabels
                    if bhgBreakBull
                        label.new(bar_index, low, "üöÄ GO", style=label.style_label_up, color=color.new(color.lime, 10), textcolor=color.black, size=size.normal)
                    else
                        label.new(bar_index, high, "üöÄ GO", style=label.style_label_down, color=color.new(color.fuchsia, 10), textcolor=color.white, size=size.normal)

    if debugMode
        log.info("Break-Hook-Go module active ‚Äî signals: " + str.tostring(bhgSignalCount) + " pullbacks: " + str.tostring(bhgPullbackCount))

//#endregion


//#region === CORRELATION ANALYSIS ===

if showCorrelation
    // TODO: Implement correlation analysis
    // - Dynamic requests for VIX, DXY, NQ (v6 feature)
    // - Rolling correlation coefficients
    // - Divergence/convergence signals
    if debugMode
        log.info("Correlation Analysis module active")

//#endregion


//#region === RISK MANAGEMENT ===

if showRiskManagement
    // TODO: Implement risk management
    // - Position sizing based on account size and risk %
    // - Stop loss placement from fib/structure levels
    // - R:R calculation and display
    if debugMode
        log.info("Risk Management module active")

//#endregion


//#region === VISUALIZATION & PLOTTING ===

// --- Debug Dashboard ---
if debugMode
    var table debugTable = table.new(position.top_right, 2, 12, bgcolor=color.new(color.black, 80), border_width=1)
    table.cell(debugTable, 0, 0, "Module",       text_color=color.white, text_size=size.small)
    table.cell(debugTable, 1, 0, "Status",       text_color=color.white, text_size=size.small)
    table.cell(debugTable, 0, 1, "Measured Moves", text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 1, showMeasuredMoves ? "ON" : "OFF", text_color=showMeasuredMoves ? color.green : color.red, text_size=size.small)
    table.cell(debugTable, 0, 2, "Auto-Fib",     text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 2, showAutoFib ? "ON" : "OFF", text_color=showAutoFib ? color.green : color.red, text_size=size.small)
    table.cell(debugTable, 0, 3, "Break-Hook-Go", text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 3, showBreakHookGo ? "ON" : "OFF", text_color=showBreakHookGo ? color.green : color.red, text_size=size.small)
    table.cell(debugTable, 0, 4, "Correlation",  text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 4, showCorrelation ? "ON" : "OFF", text_color=showCorrelation ? color.green : color.red, text_size=size.small)
    table.cell(debugTable, 0, 5, "Risk Mgmt",    text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 5, showRiskManagement ? "ON" : "OFF", text_color=showRiskManagement ? color.green : color.red, text_size=size.small)
    table.cell(debugTable, 0, 6, "Swing Highs",  text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 6, str.tostring(array.size(swingHighs)), text_color=color.orange, text_size=size.small)
    table.cell(debugTable, 0, 7, "Swing Lows",   text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 7, str.tostring(array.size(swingLows)),  text_color=color.orange, text_size=size.small)
    table.cell(debugTable, 0, 8, "Fib Direction", text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 8, fibIsBullish ? "BULL" : "BEAR", text_color=fibIsBullish ? color.teal : color.red, text_size=size.small)
    table.cell(debugTable, 0, 9, "Fib Signals",  text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 9, str.tostring(fibSignalCount), text_color=color.yellow, text_size=size.small)
    table.cell(debugTable, 0, 10, "BHG Signals",  text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 10, str.tostring(bhgSignalCount), text_color=color.lime, text_size=size.small)
    table.cell(debugTable, 0, 11, "BHG Pullbacks", text_color=color.gray, text_size=size.small)
    table.cell(debugTable, 1, 11, str.tostring(bhgPullbackCount), text_color=color.aqua, text_size=size.small)

//#endregion
