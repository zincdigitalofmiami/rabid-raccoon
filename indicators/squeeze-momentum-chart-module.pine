// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Squeeze Momentum â€” Chart Module
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Original: LazyBear (Pine v3)
// Pine v6 conversion: Kirk / ZINC Digital for Rabid Raccoon
//
// HOW IT WORKS:
// Bollinger Bands inside Keltner Channels = volatility compression (squeeze).
// When BB contracts inside KC, market is coiling. When it breaks out, momentum
// releases. The histogram shows momentum direction and acceleration via
// linear regression of price vs its midline.
//
// Dots:  Black = squeeze ON (BB inside KC, coiling)
//        Gray  = squeeze OFF (BB outside KC, firing)
//        Blue  = no squeeze (neutral)
//
// Bars:  Lime/Green  = positive momentum (lime = accelerating, green = decelerating)
//        Red/Maroon  = negative momentum (red = accelerating, maroon = decelerating)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//@version=6
indicator("Squeeze Momentum â€” Chart Module", shorttitle="ðŸ¦ SQZ", overlay=false)

// â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
length       = input.int(20, title="BB Length", minval=1)
mult         = input.float(2.0, title="BB MultFactor", minval=0.1, step=0.1)
lengthKC     = input.int(20, title="KC Length", minval=1)
multKC       = input.float(1.5, title="KC MultFactor", minval=0.1, step=0.1)
useTrueRange = input.bool(true, title="Use TrueRange (KC)")

// â”€â”€ Bollinger Bands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
float source  = close
float basis   = ta.sma(source, length)
float dev     = mult * ta.stdev(source, length)
float upperBB = basis + dev
float lowerBB = basis - dev

// â”€â”€ Keltner Channels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
float ma       = ta.sma(source, lengthKC)
float range_   = useTrueRange ? ta.tr : (high - low)
float rangema  = ta.sma(range_, lengthKC)
float upperKC  = ma + rangema * multKC
float lowerKC  = ma - rangema * multKC

// â”€â”€ Squeeze Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bool sqzOn  = (lowerBB > lowerKC) and (upperBB < upperKC)
bool sqzOff = (lowerBB < lowerKC) and (upperBB > upperKC)
bool noSqz  = not sqzOn and not sqzOff

// â”€â”€ Momentum Value â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Linear regression of (price - midline) where midline = avg of donchian mid + SMA
float midline = math.avg(math.avg(ta.highest(high, lengthKC), ta.lowest(low, lengthKC)), ta.sma(close, lengthKC))
float val     = ta.linreg(source - midline, lengthKC, 0)

// â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
color bcolor = val > 0 ?
               (val > nz(val[1]) ? color.lime : color.green) :
               (val < nz(val[1]) ? color.red : color.maroon)

color scolor = noSqz ? color.blue : sqzOn ? color.black : color.gray

// â”€â”€ Plot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(val, "Momentum", color=bcolor, style=plot.style_histogram, linewidth=4)
plot(0, "Squeeze", color=scolor, style=plot.style_cross, linewidth=2)
