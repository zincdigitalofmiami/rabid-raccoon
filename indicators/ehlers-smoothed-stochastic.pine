// Ehlers Smoothed Stochastic â€” Pine Script v6
// Original by LazyBear (v3), converted for Rabid Raccoon project
// DSP-based stochastic: Roofing Filter isolates tradeable cycles,
// Super Smoother removes noise without MA lag.
// @version=6

indicator("Ehlers Smoothed Stochastic [RR]", shorttitle="ðŸ¦ ESS", format=format.price, precision=4)

// === INPUTS ===
applyDoubleSmoothing = input.bool(false, "Apply Double Smoothing")
length               = input.int(14,     "Stoch Length")
lengthMA             = input.int(3,      "Stoch MA Length")
over_bought          = input.float(0.8,  "Overbought")
over_sold            = input.float(0.2,  "Oversold")
src                  = input.source(close, "Source")
roofingBandUpper     = input.int(48,     "Roofing Band Upper")
roofingBandLower     = input.int(10,     "Roofing Band Lower")

// === CONSTANTS ===
float PI = 3.14159265359

// === EHLERS SUPER SMOOTHER FILTER ===
// Two-pole Butterworth lowpass â€” strips high-frequency noise
EhlersSuperSmootherFilter(float price, int lower) =>
    float a1     = math.exp(-PI * math.sqrt(2) / lower)
    float coeff2 = 2 * a1 * math.cos(math.sqrt(2) * PI / lower)
    float coeff3 = -math.pow(a1, 2)
    float coeff1 = 1 - coeff2 - coeff3
    var float filt = 0.0
    filt := coeff1 * (price + nz(price[1])) / 2 + coeff2 * nz(filt[1]) + coeff3 * nz(filt[2])
    filt

// === EHLERS ROOFING FILTER ===
// Highpass removes trend drift, optional super smoother removes noise
// Together they isolate the cyclical band between upper and lower periods
EhlersRoofingFilter(float price, bool smoothed, int upper, int lower) =>
    float alpha1 = (math.cos(math.sqrt(2) * PI / upper) + math.sin(math.sqrt(2) * PI / upper) - 1) / math.cos(math.sqrt(2) * PI / upper)
    var float highpass = 0.0
    highpass := math.pow(1 - alpha1 / 2, 2) * (price - 2 * nz(price[1]) + nz(price[2])) +
                 2 * (1 - alpha1) * nz(highpass[1]) - math.pow(1 - alpha1, 2) * nz(highpass[2])
    smoothed ? EhlersSuperSmootherFilter(highpass, lower) : highpass

// === EHLERS STOCHASTIC ===
// Standard stochastic formula on roofing-filtered data (not raw price)
EhlersStochastic(float price, int len, bool applySmoothing, int upper, int lower) =>
    float filt     = EhlersRoofingFilter(price, applySmoothing, upper, lower)
    float highestP = ta.highest(filt, len)
    float lowestP  = ta.lowest(filt, len)
    (highestP - lowestP) != 0 ? (filt - lowestP) / (highestP - lowestP) : 0.0

// === COMPUTE ===
float stoch = EhlersSuperSmootherFilter(EhlersStochastic(src, length, applyDoubleSmoothing, roofingBandUpper, roofingBandLower), roofingBandLower)

// === PLOT ===
hline(over_bought,                       "Overbought", color=color.new(color.gray, 50), linestyle=hline.style_dashed)
hline(over_sold,                         "Oversold",   color=color.new(color.gray, 50), linestyle=hline.style_dashed)
hline((over_bought + over_sold) / 2,     "Midline",    color=color.new(color.gray, 70), linestyle=hline.style_dotted)
plot(ta.sma(stoch, lengthMA), "Stoch MA", color=color.red,  linewidth=1)
plot(stoch,                   "Stoch",    color=color.blue, linewidth=1)
